<!DOCTYPE html>
<html>
<head>
    <title>Stocks</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #00FF00; font-family: 'Courier New', monospace; margin: 0; padding: 20px; overflow: hidden; display: flex; gap: 20px;}
        
        /* Left Side: Grid */
        .stock-container { flex: 3; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; align-content: start; }
        
        /* Right Side: Feed */
        .feed-container { flex: 1; background: rgba(0,0,0,0.9); border: 2px solid white; padding: 10px; height: fit-content; min-height: 200px; }
        .feed-title { color: yellow; text-align: center; border-bottom: 1px solid white; padding-bottom: 5px; margin-bottom: 10px; font-weight: bold;}
        .feed-item { color: white; font-size: 0.9em; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }

        .card { background: rgba(0,0,0,0.85); color: white; border: 2px solid white; padding: 10px; border-radius: 5px; position: relative; }
        .header { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.4em; margin-bottom: 5px; }
        .green { color: #4caf50; }
        .sub { font-size: 0.75em; color: #ccc; margin-bottom: 5px; }
        .ceo-label { color: gold; font-weight: bold; }
        
        canvas { max-height: 60px; width: 100%; margin-top: 5px; }
        .no-data { color: black; font-size: 30px; font-weight: bold; position: absolute; top: 50%; left: 40%; }
    </style>
</head>
<body>
    <div id="container" class="stock-container"></div>
    
    <div class="feed-container">
        <div class="feed-title">LIVE TRANSACTIONS</div>
        <div id="feedList"></div>
    </div>

    <div id="empty" class="no-data">WAITING FOR STOCKS...</div>

    <script>
        const socket = io();
        const charts = {};
        let allStocks = [];

        // 1. Handle Transaction Log
        socket.on('log_update', (logs) => {
            const feed = document.getElementById('feedList');
            feed.innerHTML = logs.map(l => `<div class="feed-item">> ${l}</div>`).join('');
        });

        // 2. Handle Stock Data
        socket.on('update', (data) => {
            const container = document.getElementById('container');
            const empty = document.getElementById('empty');
            
            if (data.stocks.length > 0) empty.style.display = 'none';
            else empty.style.display = 'block';
            
            // Store stocks
            allStocks = data.stocks;
            
            // Sort by price (high to low) on every update
            allStocks.sort((a, b) => b.value - a.value);
            
            // Clear and rebuild in sorted order
            container.innerHTML = '';
            
            allStocks.forEach(s => {
                let card = document.createElement('div');
                card.className = 'card';
                card.id = `stock-${s.id}`;
                
                // Calculate CEO (Top Shareholder)
                let topUser = 'None';
                let max = -1;
                for (let [u, amt] of Object.entries(s.shareholders)) {
                    if (amt > max) { max = amt; topUser = u; }
                }

                card.innerHTML = `
                    <div class="header">
                        <span>${s.name}</span>
                        <span class="green" id="price-${s.id}">$${s.value.toFixed(2)}</span>
                    </div>
                    <div class="sub">
                        <div>PARAM: ${s.paramType}</div>
                        <div>CEO: <span class="ceo-label" id="ceo-${s.id}">${topUser}</span> (${max})</div>
                    </div>
                    <canvas id="canvas-${s.id}"></canvas>
                `;
                container.appendChild(card);

                // Chart
                const ctx = document.getElementById(`canvas-${s.id}`).getContext('2d');
                charts[s.id] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: s.history.map((_, i) => i),
                        datasets: [{
                            data: s.history,
                            borderColor: '#4caf50',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.3,
                            fill: false
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, animation: false }
                });
            });
        });
    </script>
</body>
</html>